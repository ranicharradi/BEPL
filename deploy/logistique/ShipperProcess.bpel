<?xml version="1.0" encoding="UTF-8"?>
<bpel:process name="ShipperProcess"
  targetNamespace="http://exemple.com/bpel/shipper"
  suppressJoinFailure="yes"
  expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"
  queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"
  xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:ship="http://exemple.com/shipper"
  xmlns:store="http://exemple.com/store"
  xmlns:plnk="http://docs.oasis-open.org/wsbpel/2.0/plnktype">

  <bpel:import importType="http://schemas.xmlsoap.org/wsdl/" namespace="http://exemple.com/shipper" location="Shipper.wsdl"/>
  <bpel:import importType="http://schemas.xmlsoap.org/wsdl/" namespace="http://exemple.com/store" location="Store.wsdl"/>

  <bpel:partnerLinks>
    <bpel:partnerLink name="plMagasin" partnerLinkType="ship:pltShipperStore" myRole="shipper" partnerRole="store"/>
  </bpel:partnerLinks>

  <bpel:variables>
    <bpel:variable name="varExpedition" messageType="ship:shippingDetailsMessage"/>
    <bpel:variable name="varStatutExpedition" messageType="store:shippingStatusMessage"/>
  </bpel:variables>

  <bpel:sequence name="fluxTransporteur">
    <bpel:receive name="recevoirDemandeTransport"
      partnerLink="plMagasin"
      portType="ship:ShipperPortType"
      operation="requestShipping"
      variable="varExpedition"
      createInstance="yes"/>

    <bpel:wait name="attendrePreparation">
      <bpel:for>'PT15S'</bpel:for>
    </bpel:wait>

    <bpel:assign name="preparerStatutMagasin">
      <bpel:copy>
        <bpel:from variable="varExpedition" part="payload" query="/ship:shippingDetails/ship:commandeId"/>
        <bpel:to variable="varStatutExpedition" part="payload" query="/store:shippingStatus/store:commandeId"/>
      </bpel:copy>
      <bpel:copy>
        <bpel:from>
          <bpel:literal>EXPEDIE</bpel:literal>
        </bpel:from>
        <bpel:to variable="varStatutExpedition" part="payload" query="/store:shippingStatus/store:statut"/>
      </bpel:copy>
      <bpel:copy>
        <bpel:from>
          <bpel:literal>TRK-12345</bpel:literal>
        </bpel:from>
        <bpel:to variable="varStatutExpedition" part="payload" query="/store:shippingStatus/store:trackingId"/>
      </bpel:copy>
    </bpel:assign>

    <bpel:invoke name="notifierMagasin"
      partnerLink="plMagasin"
      portType="store:StorePortType"
      operation="receiveShippingStatus"
      inputVariable="varStatutExpedition"/>
  </bpel:sequence>
</bpel:process>
